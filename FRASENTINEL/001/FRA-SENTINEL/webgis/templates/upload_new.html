<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRA Sentinel Upload System</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        .upload-area {
            border: 2px dashed #4caf50;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8fff8;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background: #f0fff0;
            border-color: #2e7d32;
        }
        
        .upload-area.dragover {
            background: #e8f5e8;
            border-color: #1b5e20;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #2e7d32);
            transition: width 0.3s ease;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .step.active .step-number {
            background: #4caf50;
            color: white;
        }
        
        .step.completed .step-number {
            background: #2e7d32;
            color: white;
        }
        
        .step.pending .step-number {
            background: #e0e0e0;
            color: #666;
        }
        
        .map-container {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .scheme-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .scheme-card.eligible {
            border-left: 4px solid #4caf50;
        }
        
        .scheme-card.not-eligible {
            border-left: 4px solid #f44336;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success {
            background: #4caf50;
        }
        
        .toast.error {
            background: #f44336;
        }
        
        .toast.info {
            background: #2196f3;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">FRA Sentinel Upload System</h1>
                    <p class="text-sm text-gray-600">Government User ‚Üí Upload ‚Üí Extract ‚Üí Map ‚Üí DSS</p>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/dashboard" class="text-gray-600 hover:text-gray-900">‚Üê Back to Dashboard</a>
                    <button onclick="showSettings()" class="flex items-center px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                        ‚öôÔ∏è Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Breadcrumb -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="step-indicator py-3">
                <div class="step active" id="step-upload">
                    <div class="step-number">1</div>
                    <span>Upload & Extract</span>
                </div>
                <div class="step pending" id="step-map">
                    <div class="step-number">2</div>
                    <span>Map Editor</span>
                </div>
                <div class="step pending" id="step-dss">
                    <div class="step-number">3</div>
                    <span>DSS Analysis</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Step 1: Upload -->
        <div id="upload-step" class="step-content">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Upload Patta Documents</h2>
                <p class="text-gray-600 mb-6">Upload JPG, PNG, or PDF files for OCR processing and DSS analysis</p>
                
                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                    <div class="text-4xl mb-4">üì§</div>
                    <p class="text-lg font-medium text-gray-700 mb-2">Drag & drop files here</p>
                    <p class="text-sm text-gray-500 mb-4">or click to browse files</p>
                    <p class="text-xs text-gray-400">Supports JPG, PNG, PDF (max 10MB each)</p>
                </div>
                
                <input type="file" id="file-input" class="hidden" multiple accept=".jpg,.jpeg,.png,.pdf">
                
                <div id="file-list" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Files</h3>
                    <div id="files-container"></div>
                    <button id="process-btn" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>
                        Process Files
                    </button>
                </div>
                
                <div id="processing-status" class="mt-6 hidden">
                    <div class="flex items-center mb-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                        <span class="text-sm text-gray-600">Processing files...</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Map Editor -->
        <div id="map-step" class="step-content hidden">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Map Editor</h2>
                <p class="text-gray-600 mb-6">Review and edit the extracted location data</p>
                
                <div id="extracted-data" class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-900 mb-2">Extracted Data</h3>
                    <div id="data-summary" class="text-sm text-gray-600"></div>
                </div>
                
                <div class="map-container" id="map"></div>
                
                <div class="flex justify-between mt-6">
                    <button onclick="goToStep('upload')" class="px-4 py-2 text-gray-600 hover:text-gray-900">
                        ‚Üê Back to Upload
                    </button>
                    <button onclick="goToStep('dss')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Continue to DSS ‚Üí
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: DSS Analysis -->
        <div id="dss-step" class="step-content hidden">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">DSS Recommendations</h2>
                <p class="text-gray-600 mb-6">Government scheme recommendations based on your data</p>
                
                <div id="dss-results" class="space-y-4">
                    <!-- DSS results will be populated here -->
                </div>
                
                <div class="flex justify-between mt-6">
                    <button onclick="goToStep('map')" class="px-4 py-2 text-gray-600 hover:text-gray-900">
                        ‚Üê Back to Map
                    </button>
                    <button onclick="resetWorkflow()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Start New Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex items-center justify-between p-6 border-b">
                <h2 class="text-xl font-semibold text-gray-900">Settings</h2>
                <button onclick="hideSettings()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Base URL</label>
                    <input type="url" id="api-url" value="http://localhost:5000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Max File Size (MB)</label>
                    <input type="number" id="max-file-size" value="10" min="1" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideSettings()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let uploadedFiles = [];
        let extractedData = null;
        let map = null;
        let currentStep = 'upload';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeUpload();
            loadSettings();
        });

        // Upload functionality
        function initializeUpload() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', function(e) {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            uploadedFiles = Array.from(files);
            displayFiles();
            showToast('Files added successfully', 'success');
        }

        function displayFiles() {
            const fileList = document.getElementById('file-list');
            const filesContainer = document.getElementById('files-container');
            
            if (uploadedFiles.length === 0) {
                fileList.classList.add('hidden');
                return;
            }

            fileList.classList.remove('hidden');
            filesContainer.innerHTML = '';

            uploadedFiles.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex items-center justify-between p-3 border rounded-lg mb-2';
                fileDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">üìÑ</span>
                        <div>
                            <p class="font-medium text-gray-900">${file.name}</p>
                            <p class="text-sm text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">‚úï</button>
                `;
                filesContainer.appendChild(fileDiv);
            });

            document.getElementById('process-btn').disabled = false;
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFiles();
        }

        async function processFiles() {
            const processBtn = document.getElementById('process-btn');
            const processingStatus = document.getElementById('processing-status');
            
            processBtn.disabled = true;
            processingStatus.classList.remove('hidden');

            try {
                // Simulate processing
                for (let i = 0; i <= 100; i += 10) {
                    document.getElementById('progress-fill').style.width = i + '%';
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                // Mock extracted data
                extractedData = {
                    claimantNames: ['Sample Claimant'],
                    village: 'Sample Village',
                    district: 'Sample District',
                    areaValues: { hectares: 2.5 },
                    claimType: 'IFR',
                    coordinates: { latitude: 21.8225, longitude: 75.6102 }
                };

                showToast('Files processed successfully!', 'success');
                goToStep('map');

            } catch (error) {
                showToast('Processing failed: ' + error.message, 'error');
            } finally {
                processingStatus.classList.add('hidden');
                processBtn.disabled = false;
            }
        }

        // Step navigation
        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            
            // Show selected step
            document.getElementById(step + '-step').classList.remove('hidden');
            
            // Update step indicators
            document.querySelectorAll('.step').forEach(el => {
                el.classList.remove('active', 'completed');
                el.classList.add('pending');
            });

            const stepMap = { upload: 0, map: 1, dss: 2 };
            const currentIndex = stepMap[step];
            
            for (let i = 0; i <= currentIndex; i++) {
                const stepEl = document.querySelectorAll('.step')[i];
                if (i < currentIndex) {
                    stepEl.classList.remove('pending');
                    stepEl.classList.add('completed');
                } else {
                    stepEl.classList.remove('pending');
                    stepEl.classList.add('active');
                }
            }

            currentStep = step;

            // Initialize step-specific functionality
            if (step === 'map') {
                initializeMap();
                displayExtractedData();
            } else if (step === 'dss') {
                loadDSSRecommendations();
            }
        }

        function initializeMap() {
            if (map) return;

            map = L.map('map').setView([21.8225, 75.6102], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            if (extractedData && extractedData.coordinates) {
                const { latitude, longitude } = extractedData.coordinates;
                L.marker([latitude, longitude]).addTo(map)
                    .bindPopup(`<b>${extractedData.village}</b><br>Area: ${extractedData.areaValues.hectares} hectares`)
                    .openPopup();
            }
        }

        function displayExtractedData() {
            if (!extractedData) return;

            const summary = document.getElementById('data-summary');
            summary.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>Village:</strong> ${extractedData.village}</div>
                    <div><strong>Claimant:</strong> ${extractedData.claimantNames[0]}</div>
                    <div><strong>Area:</strong> ${extractedData.areaValues.hectares} hectares</div>
                    <div><strong>Claim Type:</strong> ${extractedData.claimType}</div>
                </div>
            `;
        }

        async function loadDSSRecommendations() {
            const dssResults = document.getElementById('dss-results');
            
            // Mock DSS recommendations
            const recommendations = [
                {
                    schemeName: 'Forest Rights Act Individual Rights',
                    ministry: 'Ministry of Tribal Affairs',
                    score: 95,
                    eligibility: true,
                    reasons: ['Eligible for individual forest rights', 'Traditional forest dweller status confirmed'],
                    guidelines: ['Submit application to Gram Sabha', 'Provide traditional occupation proof']
                },
                {
                    schemeName: 'Jal Jeevan Mission',
                    ministry: 'Ministry of Jal Shakti',
                    score: 78,
                    eligibility: true,
                    reasons: ['Rural area coverage', 'Water scarcity region'],
                    guidelines: ['Contact local water department', 'Submit household survey form']
                }
            ];

            dssResults.innerHTML = '';
            recommendations.forEach(rec => {
                const card = document.createElement('div');
                card.className = `scheme-card ${rec.eligibility ? 'eligible' : 'not-eligible'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-900">${rec.schemeName}</h3>
                        <span class="px-2 py-1 rounded-full text-sm font-medium ${rec.eligibility ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${rec.score}%
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${rec.ministry}</p>
                    <div class="text-sm">
                        <p class="font-medium text-gray-700 mb-1">Reasons:</p>
                        <ul class="list-disc list-inside text-gray-600">
                            ${rec.reasons.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                `;
                dssResults.appendChild(card);
            });
        }

        function resetWorkflow() {
            uploadedFiles = [];
            extractedData = null;
            if (map) {
                map.remove();
                map = null;
            }
            goToStep('upload');
            document.getElementById('file-list').classList.add('hidden');
            document.getElementById('files-container').innerHTML = '';
        }

        // Settings
        function showSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function hideSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const apiUrl = document.getElementById('api-url').value;
            const maxFileSize = document.getElementById('max-file-size').value;
            
            localStorage.setItem('fra-api-url', apiUrl);
            localStorage.setItem('fra-max-file-size', maxFileSize);
            
            showToast('Settings saved successfully', 'success');
            hideSettings();
        }

        function loadSettings() {
            const apiUrl = localStorage.getItem('fra-api-url') || 'http://localhost:5000';
            const maxFileSize = localStorage.getItem('fra-max-file-size') || '10';
            
            document.getElementById('api-url').value = apiUrl;
            document.getElementById('max-file-size').value = maxFileSize;
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Event listeners
        document.getElementById('process-btn').addEventListener('click', processFiles);
    </script>
</body>
</html>